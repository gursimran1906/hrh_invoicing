{% extends 'base.html' %}
{% block title %}Edit {{ title }}{% endblock %} 
{% block container %}
<form class="mt-2 p-4 bg-white rounded-lg shadow" method="post" {% if title == 'Client' %}id="client_form"{% endif %}>
    <h2 class="text-2xl mb-2">Edit {{ title }}</h2>
    {% csrf_token %}
    {{ form.as_p }}
    {% if title == 'Client' %}
    <fieldset class="">
        <legend>Rates</legend>
        {{ form.rates_formset.management_form }}
        <div id="rates_formset">
            {% for form in form.rates_formset %}
            <div class="flex items-center">
                {{ form.as_table }}
            </div>
            {% endfor %}
        </div>
        <button type="button" class="p-2 bg-blue-600 text-white rounded-lg text-sm float-end" id="add_rate_btn">Add Rate</button>
    </fieldset>
    {{ document_form.as_p }}
    {% endif %}
    <button class="mt-2 text-center text-white bg-blue-600 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg border text-sm px-2 py-2 me-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-600 focus:outline-none dark:focus:ring-blue-800" type="submit">Save Changes</button>
</form>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const clientTypeField = document.querySelector("#id_client_type");
        const payableByLabel = document.querySelector("label[for='id_payable_by']");
        const payableByField = document.querySelector("#id_payable_by");
        const refNumLabel = document.querySelector("label[for='id_resident_name_number']");
        const refNumField = document.querySelector("#id_resident_name_number");

        clientTypeField.addEventListener("change", function() {
            if (this.value === "private_funded") {
                payableByLabel.style.display = "none";
                payableByField.style.display = "none";
                refNumLabel.style.display = "none";
                refNumField.style.display = "none";
            } else {
                payableByLabel.style.display = "block";
                payableByField.style.display = "block";
                refNumLabel.style.display = "block";
                refNumField.style.display = "block";
            }
        });

        // Trigger change event on page load to check initial value
        clientTypeField.dispatchEvent(new Event("change"));
    });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
      var addRateBtn = document.getElementById("add_rate_btn");
      var ratesFormset = document.getElementById("rates_formset");
      var totalFormsInput = document.getElementById("id_form-TOTAL_FORMS");
  
      addRateBtn.addEventListener("click", function() {
          var formCount = parseInt(totalFormsInput.value) - 1;
          var lastChild = ratesFormset.lastElementChild;
          var newForm = lastChild.cloneNode(true);
          
          newForm.innerHTML = newForm.innerHTML.replace(/form-\d/g, 'form-' + (formCount + 1));
          console.log(newForm.innerHTML)
          ratesFormset.appendChild(newForm);
          formCount = formCount + 1;
  
          console.log(formCount)
          var amountInput = newForm.querySelector('input[name="form-' + formCount + '-amount"]');
          console.log(amountInput)
          var currentAmount = parseFloat(amountInput.value);
          amountInput.value = (currentAmount * 1.10).toFixed(2);
  
          // Set status as inactive in previous formset
          if (formCount > 0) {
              var prevFormIndex = formCount - 1;
              var prevStatusInput = document.querySelector('select[name="form-' + prevFormIndex + '-status"]');
              prevStatusInput.value = 'inactive';
          }
          
          totalFormsInput.value = formCount + 1;
      });
  });
  </script>
  
  
{% endblock %}
